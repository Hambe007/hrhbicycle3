<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRH Bicycle System</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HRH Bicycle System</h1>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container no-print">
            <button class="tab-button active" onclick="showTab('issue')">Issue Bicycle</button>
            <button class="tab-button" onclick="showTab('return')">Return Bicycle</button>
            <button class="tab-button" onclick="showTab('maintenance')">Maintenance</button>
            <button class="tab-button" onclick="showTab('reports')">Reports</button>
        </div>

        <!-- Tab Content Containers -->
        <div id="issueTab" class="tab-content active"></div>
        <div id="returnTab" class="tab-content" style="display: none;"></div>
        <div id="maintenanceTab" class="tab-content" style="display: none;"></div>
        <div id="reportsTab" class="tab-content" style="display: none;"></div>

        <!-- Notification Container -->
        <div id="notification" class="notification"></div>
    </div>
  <style>
/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
    background-color: #f0f2f5;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Header */
.header {
    background-color: #3f51b5;
    color: white;
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 24px;
    text-align: center;
    margin: 0;
}

/* Navigation Tabs */
.tab-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tab-button {
    flex: 1;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    background: #e8eaf6;
    color: #3f51b5;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-button:hover {
    background: #c5cae9;
}

.tab-button.active {
    background: #3f51b5;
    color: white;
}

/* Card Styles */
.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-title {
    color: #3f51b5;
    font-size: 18px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3f51b5;
}

/* Form Styles */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #3f51b5;
    font-weight: bold;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #3f51b5;
    box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

/* Button Styles */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.2s;
}

.btn-primary {
    background: #3f51b5;
    color: white;
}

.btn-success {
    background: #4caf50;
    color: white;
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

/* Table Styles */
.table-container {
    overflow-x: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

th {
    background: #3f51b5;
    color: white;
    font-weight: bold;
}

tr:nth-child(even) {
    background: #f8f9fa;
}

/* Status Badges */
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-active {
    background: #e8f5e9;
    color: #2e7d32;
}

.status-returned {
    background: #e3f2fd;
    color: #1565c0;
}

.status-maintenance {
    background: #fff3e0;
    color: #ef6c00;
}

/* Notification */
.notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 4px;
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: none;
    z-index: 1000;
}

.notification.success {
    background: #4caf50;
}

.notification.error {
    background: #f44336;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    position: relative;
}

.close {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }

    .tab-container {
        flex-direction: column;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .btn {
        width: 100%;
        margin-bottom: 5px;
    }

    .header h1 {
        font-size: 20px;
    }
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        background: white;
    }
    
    .container {
        padding: 0;
        max-width: none;
    }
    
    .card {
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
</style>
  <!-- Add this inside the issueTab div -->
<div class="card">
    <h3 class="card-title">Issue Bicycle</h3>
    <form id="issueForm">
        <div class="form-row">
            <div class="form-group">
                <label>Room Number *</label>
                <input type="text" class="form-control" id="roomNumber" required 
                       placeholder="Enter room number"
                       pattern="[0-9]+"
                       title="Please enter a valid room number">
            </div>
            <div class="form-group">
                <label>Guest Name *</label>
                <input type="text" class="form-control" id="guestName" required 
                       placeholder="Enter guest name">
            </div>
            <div class="form-group">
                <label>Bicycle Type *</label>
                <select class="form-control" id="bicycleType" required onchange="updateBicycleNumbers()">
                    <option value="">Select Bicycle Type</option>
                    <option value="regular">Regular Bicycle</option>
                    <option value="kids">Kids Bicycle</option>
                    <option value="libero">Libero Bicycle</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bicycle Number *</label>
                <select class="form-control" id="bicycleNumber" required>
                    <option value="">Select Bicycle Number</option>
                </select>
            </div>
            <div class="form-group">
                <label>Lock Code *</label>
                <input type="text" class="form-control" id="lockCode" required 
                       pattern="[0-9]{4}" maxlength="4"
                       placeholder="Enter 4-digit code"
                       title="Please enter a 4-digit code">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Issue Date</label>
                <input type="datetime-local" class="form-control" id="issueDate" required>
            </div>
            <div class="form-group">
                <label>Return Date *</label>
                <input type="date" class="form-control" id="returnDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea class="form-control" id="issueNotes" rows="2" 
                          placeholder="Any special requirements or notes"></textarea>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Issue Bicycle</button>
    </form>
</div>

<!-- Recent Issues Table -->
<div class="card">
    <h3 class="card-title">Recent Issues</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Room</th>
                    <th>Guest Name</th>
                    <th>Bicycle</th>
                    <th>Lock Code</th>
                    <th>Issue Date</th>
                    <th>Return Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="recentIssuesTable">
                <!-- Will be populated dynamically -->
            </tbody>
        </table>
    </div>
</div>
  <!-- Return Tab Content -->
<div class="card">
    <h3 class="card-title">Search Rentals</h3>
    <div class="form-row">
        <div class="form-group">
            <label>Search by Room Number</label>
            <input type="text" class="form-control" id="searchRoom" 
                   placeholder="Enter room number">
        </div>
        <div class="form-group">
            <label>Search by Bicycle Number</label>
            <input type="text" class="form-control" id="searchBicycle" 
                   placeholder="Enter bicycle number">
        </div>
        <div class="form-group" style="align-self: flex-end;">
            <button class="btn btn-primary" onclick="searchActiveRentals()">Search</button>
            <button class="btn btn-warning" onclick="resetSearch()">Reset</button>
        </div>
    </div>
</div>

<!-- Active Rentals Table -->
<div class="card">
    <h3 class="card-title">Active Rentals</h3>
    <div class="table-container">
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Room</th>
                    <th>Guest Name</th>
                    <th>Bicycle Type</th>
                    <th>Bicycle No.</th>
                    <th>Lock Code</th>
                    <th>Issue Date</th>
                    <th>Return Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="activeRentalsTable">
                <!-- Will be populated dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- Return Form Modal -->
<div id="returnModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Return Bicycle</h3>
        <form id="returnForm">
            <input type="hidden" id="returnRentalId">
            <div class="form-group">
                <label>Return Date</label>
                <input type="datetime-local" class="form-control" id="actualReturnDate" required>
            </div>
            <div class="form-group">
                <label>Condition</label>
                <select class="form-control" id="returnCondition" required>
                    <option value="good">Good</option>
                    <option value="damaged">Damaged</option>
                    <option value="maintenance">Needs Maintenance</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea class="form-control" id="returnNotes" rows="3" 
                          placeholder="Any issues or comments?"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Confirm Return</button>
            <button type="button" class="btn btn-danger" onclick="closeReturnModal()">Cancel</button>
        </form>
    </div>
</div>
  <!-- Maintenance Status Overview -->
<div class="card">
    <h3 class="card-title">Maintenance Overview</h3>
    <div class="status-overview">
        <div class="status-grid">
            <div class="status-item">
                <div class="status-value" id="pendingCount">0</div>
                <div class="status-label">Pending</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="inProgressCount">0</div>
                <div class="status-label">In Progress</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="completedCount">0</div>
                <div class="status-label">Completed Today</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalActiveCount">0</div>
                <div class="status-label">Total Active Cases</div>
            </div>
        </div>
    </div>
</div>

<!-- Maintenance Form -->
<div class="card">
    <h3 class="card-title">Report Maintenance Issue</h3>
    <form id="maintenanceForm">
        <div class="form-row">
            <div class="form-group">
                <label>Bicycle Type *</label>
                <select class="form-control" id="maintBicycleType" required onchange="updateMaintBicycleNumbers()">
                    <option value="">Select Type</option>
                    <option value="regular">Regular Bicycle</option>
                    <option value="kids">Kids Bicycle</option>
                    <option value="libero">Libero Bicycle</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bicycle Number *</label>
                <select class="form-control" id="maintBicycleNumber" required>
                    <option value="">Select Number</option>
                </select>
            </div>
            <div class="form-group">
                <label>Issue Type *</label>
                <select class="form-control" id="issueType" required>
                    <option value="">Select Issue Type</option>
                    <option value="mechanical">Mechanical Issue</option>
                    <option value="electrical">Electrical Issue</option>
                    <option value="frame">Frame/Structure Damage</option>
                    <option value="tire">Tire/Wheel Issue</option>
                    <option value="brake">Brake System</option>
                    <option value="chain">Chain/Gear Issue</option>
                    <option value="seat">Seat/Handle Issue</option>
                    <option value="inspection">Regular Inspection</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority *</label>
                <select class="form-control" id="priority" required>
                    <option value="high">High Priority</option>
                    <option value="medium">Medium Priority</option>
                    <option value="low">Low Priority</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Issue Description *</label>
            <textarea class="form-control" id="issueDescription" rows="3" required
                      placeholder="Detailed description of the issue..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Maintenance Request</button>
    </form>
</div>

<!-- Maintenance Records -->
<div class="card">
    <h3 class="card-title">Maintenance Records</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Bicycle</th>
                    <th>Issue Type</th>
                    <th>Description</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Reported Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="maintenanceTable">
                <!-- Will be populated dynamically -->
            </tbody>
        </table>
    </div>
</div>
  <!-- Reports Overview Cards -->
<div class="reports-grid">
    <div class="report-card" onclick="generateDailyReport()">
        <div class="report-icon">ðŸ“Š</div>
        <div class="report-title">Daily Report</div>
        <div class="report-description">
            Summary of today's activities
        </div>
    </div>

    <div class="report-card" onclick="showCustomReport('rental')">
        <div class="report-icon">ðŸ“‹</div>
        <div class="report-title">Rental Report</div>
        <div class="report-description">
            Detailed rental history
        </div>
    </div>

    <div class="report-card" onclick="showCustomReport('maintenance')">
        <div class="report-icon">ðŸ”§</div>
        <div class="report-title">Maintenance Report</div>
        <div class="report-description">
            Maintenance history and status
        </div>
    </div>

    <div class="report-card" onclick="showCustomReport('inventory')">
        <div class="report-icon">ðŸš²</div>
        <div class="report-title">Inventory Status</div>
        <div class="report-description">
            Current bicycle inventory status
        </div>
    </div>
</div>

<!-- Report Generator -->
<div class="card" id="reportGenerator" style="display: none;">
    <h3 class="card-title">Generate Report</h3>
    <div class="form-row">
        <div class="form-group">
            <label>Date Range</label>
            <select class="form-control" id="dateRange" onchange="handleDateRangeChange()">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="form-group" id="customDateRange" style="display: none;">
            <div class="date-range-picker">
                <div>
                    <label>Start Date</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div>
                    <label>End Date</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
            </div>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
        </div>
    </div>
</div>

<!-- Report Display -->
<div class="card" id="reportDisplay" style="display: none;">
    <div class="report-header">
        <h3 class="card-title">Report</h3>
        <div class="report-actions">
            <button class="btn btn-success" onclick="exportReport()">Export</button>
            <button class="btn btn-primary" onclick="printReport()">Print</button>
        </div>
    </div>
    <div id="reportContent"></div>
</div>
  <script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBjAGc8L0bkO_2RbWi0-rw7__lSHCoBrJQ",
    authDomain: "bicycle-issuing-system2.firebaseapp.com",
    projectId: "bicycle-issuing-system2",
    storageBucket: "bicycle-issuing-system2.firebasestorage.app",
    messagingSenderId: "64926990610",
    appId: "1:64926990610:web:f45390888ea1d0dfb5f3cb"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Bicycle Inventory Data Structure
const bicycleInventory = {
    regular: Array.from({ length: 501 }, (_, i) => ({
        number: (1000 + i).toString(),
        type: 'Regular Bicycle',
        status: 'Available'
    })),
    kids: Array.from({ length: 100 }, (_, i) => ({
        number: `K${String(i + 1).padStart(2, '0')}`,
        type: 'Kids Bicycle',
        status: 'Available'
    })),
    libero: Array.from({ length: 40 }, (_, i) => ({
        number: `Libero ${String(i + 1).padStart(2, '0')}`,
        type: 'Libero Bicycle',
        status: 'Available'
    }))
};

// Tab Switching Function
function showTab(tabName) {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => button.classList.remove('active'));
    tabContents.forEach(content => content.style.display = 'none');
    
    document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`${tabName}Tab`).style.display = 'block';

    // Initialize content based on tab
    switch(tabName) {
        case 'issue':
            loadRecentIssues();
            break;
        case 'return':
            loadActiveRentals();
            break;
        case 'maintenance':
            loadMaintenanceRecords();
            loadMaintenanceStats();
            break;
        case 'reports':
            resetReportView();
            break;
    }
}

// Utility Functions
function formatDate(dateString) {
    return new Date(dateString).toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';

    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function showLoading(show) {
    const overlays = document.querySelectorAll('.loading-overlay');
    overlays.forEach(overlay => {
        overlay.style.display = show ? 'flex' : 'none';
    });
}

// Initialize system
document.addEventListener('DOMContentLoaded', () => {
    // Show default tab
    showTab('issue');
    
    // Set default dates
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('issueDate').value = now.toISOString().slice(0, 16);
    
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('returnDate').value = tomorrow.toISOString().slice(0, 10);
    
    // Initialize modal close buttons
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(button => {
        button.onclick = function() {
            this.closest('.modal').style.display = 'none';
        };
    });

    // Close modals on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    };
});
</script>
  <script>
// Issue Tab Functions
function updateBicycleNumbers() {
    const typeSelect = document.getElementById('bicycleType');
    const numberSelect = document.getElementById('bicycleNumber');
    const selectedType = typeSelect.value;

    numberSelect.innerHTML = '<option value="">Select Bicycle Number</option>';

    if (selectedType) {
        const availableBikes = bicycleInventory[selectedType].filter(b => b.status === 'Available');
        availableBikes.forEach(bike => {
            const option = document.createElement('option');
            option.value = bike.number;
            option.textContent = bike.number;
            numberSelect.appendChild(option);
        });
    }
}

// Handle issue form submission
document.getElementById('issueForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
        roomNumber: document.getElementById('roomNumber').value,
        guestName: document.getElementById('guestName').value,
        bicycleType: document.getElementById('bicycleType').value,
        bicycleNumber: document.getElementById('bicycleNumber').value,
        lockCode: document.getElementById('lockCode').value,
        issueDate: new Date(document.getElementById('issueDate').value).toISOString(),
        returnDate: new Date(document.getElementById('returnDate').value).toISOString(),
        notes: document.getElementById('issueNotes').value,
        status: 'Active',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        if (new Date(formData.returnDate) < new Date(formData.issueDate)) {
            throw new Error('Return date cannot be earlier than issue date');
        }

        await db.collection('rentals').add(formData);
        updateBicycleStatus(formData.bicycleType, formData.bicycleNumber, 'In Use');
        
        showNotification('Bicycle issued successfully', 'success');
        e.target.reset();
        
        // Reset date fields
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('issueDate').value = now.toISOString().slice(0, 16);
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('returnDate').value = tomorrow.toISOString().slice(0, 10);
        
        loadRecentIssues();
        
    } catch (error) {
        console.error('Error issuing bicycle:', error);
        showNotification(error.message || 'Error issuing bicycle', 'error');
    }
});

// Load recent issues
function loadRecentIssues() {
    showLoading(true);
    db.collection('rentals')
        .orderBy('timestamp', 'desc')
        .limit(10)
        .get()
        .then(snapshot => {
            const tbody = document.getElementById('recentIssuesTable');
            tbody.innerHTML = '';

            snapshot.forEach(doc => {
                const rental = doc.data();
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${rental.roomNumber}</td>
                    <td>${rental.guestName}</td>
                    <td>${rental.bicycleNumber}</td>
                    <td>${rental.lockCode}</td>
                    <td>${formatDate(rental.issueDate)}</td>
                    <td>${formatDate(rental.returnDate)}</td>
                    <td>
                        <span class="status-badge status-${rental.status.toLowerCase()}">
                            ${rental.status}
                        </span>
                    </td>
                    <td>
                        ${rental.status === 'Active' ? `
                            <button class="btn btn-success" 
                                    onclick="openReturnModal('${doc.id}')">Return</button>
                            <button class="btn btn-warning" 
                                    onclick="extendRental('${doc.id}')">Extend</button>
                        ` : ''}
                    </td>
                `;
            });
        })
        .catch(error => {
            console.error("Error loading recent issues:", error);
            showNotification("Error loading recent issues", "error");
        })
        .finally(() => {
            showLoading(false);
        });
}

// Return functions
function openReturnModal(rentalId) {
    const modal = document.getElementById('returnModal');
    document.getElementById('returnRentalId').value = rentalId;
    
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('actualReturnDate').value = now.toISOString().slice(0, 16);
    
    modal.style.display = 'block';
}

function closeReturnModal() {
    document.getElementById('returnModal').style.display = 'none';
    document.getElementById('returnForm').reset();
}

document.getElementById('returnForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const rentalId = document.getElementById('returnRentalId').value;
    const returnData = {
        status: 'Returned',
        actualReturnDate: new Date(document.getElementById('actualReturnDate').value).toISOString(),
        returnCondition: document.getElementById('returnCondition').value,
        returnNotes: document.getElementById('returnNotes').value
    };

    try {
        const rentalDoc = await db.collection('rentals').doc(rentalId).get();
        const rental = rentalDoc.data();

        await db.collection('rentals').doc(rentalId).update(returnData);

        const newStatus = returnData.returnCondition === 'maintenance' ? 'Maintenance' : 'Available';
        updateBicycleStatus(rental.bicycleType, rental.bicycleNumber, newStatus);

        if (returnData.returnCondition === 'maintenance' || 
            returnData.returnCondition === 'damaged') {
            await createMaintenanceRecord(rental, returnData.returnNotes);
        }

        showNotification('Bicycle returned successfully', 'success');
        closeReturnModal();
        loadRecentIssues();
        loadActiveRentals();
        
    } catch (error) {
        console.error('Error returning bicycle:', error);
        showNotification('Error returning bicycle', 'error');
    }
});
</script>
  <script>
// Maintenance System Functions
function loadMaintenanceStats() {
    db.collection('maintenance')
        .get()
        .then(snapshot => {
            let stats = {
                pending: 0,
                inProgress: 0,
                completed: 0,
                total: 0
            };

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            snapshot.forEach(doc => {
                const record = doc.data();
                if (record.status === 'pending') stats.pending++;
                if (record.status === 'in-progress') stats.inProgress++;
                
                if (record.status === 'completed') {
                    const completedDate = new Date(record.completedDate);
                    if (completedDate >= today) {
                        stats.completed++;
                    }
                }

                if (record.status !== 'completed') stats.total++;
            });

            // Update statistics display
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('inProgressCount').textContent = stats.inProgress;
            document.getElementById('completedCount').textContent = stats.completed;
            document.getElementById('totalActiveCount').textContent = stats.total;
        })
        .catch(error => {
            console.error("Error loading maintenance stats:", error);
            showNotification("Error loading statistics", "error");
        });
}

function updateMaintBicycleNumbers() {
    const typeSelect = document.getElementById('maintBicycleType');
    const numberSelect = document.getElementById('maintBicycleNumber');
    const selectedType = typeSelect.value;

    numberSelect.innerHTML = '<option value="">Select Number</option>';

    if (selectedType) {
        bicycleInventory[selectedType].forEach(bike => {
            const option = document.createElement('option');
            option.value = bike.number;
            option.textContent = bike.number;
            numberSelect.appendChild(option);
        });
    }
}

// Handle maintenance form submission
document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const maintenanceData = {
        bicycleType: document.getElementById('maintBicycleType').value,
        bicycleNumber: document.getElementById('maintBicycleNumber').value,
        issueType: document.getElementById('issueType').value,
        priority: document.getElementById('priority').value,
        description: document.getElementById('issueDescription').value,
        status: 'pending',
        reportedDate: new Date().toISOString(),
        history: [{
            date: new Date().toISOString(),
            status: 'pending',
            notes: 'Maintenance issue reported'
        }]
    };

    try {
        await db.collection('maintenance').add(maintenanceData);
        updateBicycleStatus(maintenanceData.bicycleType, maintenanceData.bicycleNumber, 'Maintenance');
        
        showNotification('Maintenance request submitted successfully', 'success');
        e.target.reset();
        loadMaintenanceRecords();
        loadMaintenanceStats();
        
    } catch (error) {
        console.error('Error submitting maintenance request:', error);
        showNotification('Error submitting maintenance request', 'error');
    }
});

// Load maintenance records
function loadMaintenanceRecords() {
    showLoading(true);
    db.collection('maintenance')
        .orderBy('reportedDate', 'desc')
        .get()
        .then(snapshot => {
            const tbody = document.getElementById('maintenanceTable');
            tbody.innerHTML = '';

            snapshot.forEach(doc => {
                const record = doc.data();
                const row = tbody.insertRow();
                row.className = `priority-${record.priority}`;
                
                row.innerHTML = `
                    <td>${record.bicycleType} - ${record.bicycleNumber}</td>
                    <td>${record.issueType}</td>
                    <td>${record.description}</td>
                    <td>
                        <span class="status-badge priority-${record.priority}">
                            ${record.priority.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${record.status}">
                            ${record.status.toUpperCase()}
                        </span>
                    </td>
                    <td>${formatDate(record.reportedDate)}</td>
                    <td>
                        ${record.status !== 'completed' ? `
                            <button class="btn btn-primary" 
                                    onclick="updateMaintenanceStatus('${doc.id}')">Update</button>
                        ` : ''}
                        <button class="btn btn-info" 
                                onclick="viewMaintenanceHistory('${doc.id}')">History</button>
                    </td>
                `;
            });
        })
        .catch(error => {
            console.error("Error loading maintenance records:", error);
            showNotification("Error loading maintenance records", "error");
        })
        .finally(() => {
            showLoading(false);
        });
}

// Update maintenance status
async function updateMaintenanceStatus(recordId) {
    const status = prompt('Enter new status (pending/in-progress/completed):');
    if (!status) return;

    try {
        const validStatuses = ['pending', 'in-progress', 'completed'];
        if (!validStatuses.includes(status.toLowerCase())) {
            throw new Error('Invalid status');
        }

        const record = await db.collection('maintenance').doc(recordId).get();
        const maintenanceData = record.data();

        const historyEntry = {
            date: new Date().toISOString(),
            status: status.toLowerCase(),
            notes: `Status updated to ${status}`
        };

        await db.collection('maintenance').doc(recordId).update({
            status: status.toLowerCase(),
            history: [...(maintenanceData.history || []), historyEntry],
            completedDate: status.toLowerCase() === 'completed' ? new Date().toISOString() : null
        });

        if (status.toLowerCase() === 'completed') {
            updateBicycleStatus(maintenanceData.bicycleType, maintenanceData.bicycleNumber, 'Available');
        }

        showNotification('Maintenance status updated successfully', 'success');
        loadMaintenanceRecords();
        loadMaintenanceStats();
        
    } catch (error) {
        console.error('Error updating maintenance status:', error);
        showNotification('Error updating status', 'error');
    }
}

// View maintenance history
async function viewMaintenanceHistory(recordId) {
    try {
        const doc = await db.collection('maintenance').doc(recordId).get();
        const record = doc.data();

        const history = record.history || [];
        let historyHtml = history.map(entry => `
            <div class="history-item">
                <div class="history-date">${formatDate(entry.date)}</div>
                <div class="history-status">${entry.status.toUpperCase()}</div>
                <div class="history-notes">${entry.notes}</div>
            </div>
        `).join('');

        // Display history in a modal or alert
        alert(historyHtml.replace(/<[^>]*>/g, '\n'));
        
    } catch (error) {
        console.error('Error loading maintenance history:', error);
        showNotification('Error loading history', 'error');
    }
}

// Create maintenance record from return
async function createMaintenanceRecord(rental, notes) {
    const maintenanceData = {
        bicycleType: rental.bicycleType,
        bicycleNumber: rental.bicycleNumber,
        issueType: 'Return Inspection',
        priority: 'medium',
        description: `Maintenance required after return. Notes: ${notes}`,
        status: 'pending',
        reportedDate: new Date().toISOString(),
        history: [{
            date: new Date().toISOString(),
            status: 'pending',
            notes: 'Created from bicycle return'
        }]
    };

    try {
        await db.collection('maintenance').add(maintenanceData);
        loadMaintenanceStats();
    } catch (error) {
        console.error('Error creating maintenance record:', error);
        showNotification('Error creating maintenance record', 'error');
    }
}
</script>
  <script>
// Report System Functions
function showCustomReport(type) {
    document.getElementById('reportGenerator').style.display = 'block';
    document.getElementById('reportDisplay').style.display = 'none';
    document.getElementById('customDateRange').style.display = 'none';
}

function handleDateRangeChange() {
    const dateRange = document.getElementById('dateRange').value;
    const customDateRange = document.getElementById('customDateRange');
    
    if (dateRange === 'custom') {
        customDateRange.style.display = 'block';
    } else {
        customDateRange.style.display = 'none';
        setDefaultDates(dateRange);
    }
}

function setDefaultDates(range) {
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const today = new Date();
    
    switch(range) {
        case 'today':
            startDate.valueAsDate = today;
            endDate.valueAsDate = today;
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            startDate.valueAsDate = weekStart;
            endDate.valueAsDate = today;
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            startDate.valueAsDate = monthStart;
            endDate.valueAsDate = today;
            break;
    }
}

async function generateReport() {
    const dateRange = document.getElementById('dateRange').value;
    let startDate, endDate;

    if (dateRange === 'custom') {
        startDate = new Date(document.getElementById('startDate').value);
        endDate = new Date(document.getElementById('endDate').value);
    } else {
        startDate = new Date(document.getElementById('startDate').valueAsDate);
        endDate = new Date(document.getElementById('endDate').valueAsDate);
    }

    try {
        showLoading(true);

        // Fetch data for the report
        const rentalsSnapshot = await db.collection('rentals')
            .where('issueDate', '>=', startDate.toISOString())
            .where('issueDate', '<=', endDate.toISOString())
            .get();

        const maintenanceSnapshot = await db.collection('maintenance')
            .where('reportedDate', '>=', startDate.toISOString())
            .where('reportedDate', '<=', endDate.toISOString())
            .get();

        // Generate report HTML
        const reportHtml = `
            <div class="report-section">
                <h4>Rental Summary</h4>
                <div class="summary-stats">
                    <div>Total Rentals: ${rentalsSnapshot.size}</div>
                    <div>Active Rentals: ${rentalsSnapshot.docs.filter(doc => doc.data().status === 'Active').length}</div>
                    <div>Returned: ${rentalsSnapshot.docs.filter(doc => doc.data().status === 'Returned').length}</div>
                </div>
                
                <h4>Maintenance Summary</h4>
                <div class="summary-stats">
                    <div>Total Issues: ${maintenanceSnapshot.size}</div>
                    <div>Pending: ${maintenanceSnapshot.docs.filter(doc => doc.data().status === 'pending').length}</div>
                    <div>Completed: ${maintenanceSnapshot.docs.filter(doc => doc.data().status === 'completed').length}</div>
                </div>

                <h4>Detailed Records</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateDetailedRecords(rentalsSnapshot, maintenanceSnapshot)}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('reportContent').innerHTML = reportHtml;
        document.getElementById('reportDisplay').style.display = 'block';
        
    } catch (error) {
        console.error('Error generating report:', error);
        showNotification('Error generating report', 'error');
    } finally {
        showLoading(false);
    }
}

function generateDetailedRecords(rentals, maintenance) {
    const allRecords = [
        ...rentals.docs.map(doc => ({
            type: 'rental',
            date: doc.data().issueDate,
            data: doc.data()
        })),
        ...maintenance.docs.map(doc => ({
            type: 'maintenance',
            date: doc.data().reportedDate,
            data: doc.data()
        }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));

    return allRecords.map(record => `
        <tr>
            <td>${formatDate(record.date)}</td>
            <td>${record.type === 'rental' ? 'Rental' : 'Maintenance'}</td>
            <td>${
                record.type === 'rental' 
                    ? `Room ${record.data.roomNumber} - Bicycle ${record.data.bicycleNumber}`
                    : `${record.data.bicycleNumber} - ${record.data.issueType}`
            }</td>
            <td>
                <span class="status-badge status-${record.data.status.toLowerCase()}">
                    ${record.data.status}
                </span>
            </td>
        </tr>
    `).join('');
}

function printReport() {
    window.print();
}

function exportReport() {
    // Implement export functionality based on your needs
    alert('Export functionality coming soon!');
}

function resetReportView() {
    document.getElementById('reportGenerator').style.display = 'none';
    document.getElementById('reportDisplay').style.display = 'none';
    document.getElementById('customDateRange').style.display = 'none';
}
</script>
</body>
</html>
